<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Web/Scotty/Login/Session.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts      #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE MultiParamTypeClasses #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE OverloadedStrings     #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables   #-}</span>
<a name="line-5"></a>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>-- TODO switch to TVars?</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-|
<a name="line-10"></a>Module:              Web.Scotty.Login.Session
<a name="line-11"></a>Description:         Simple library for Scotty sessions and authorization
<a name="line-12"></a>Copyright:           (c) Miles Frankel, 2015
<a name="line-13"></a>License:             GPL-2
<a name="line-14"></a>
<a name="line-15"></a>A Simple library for session adding and checking, with automatic SQLite backup of session store. The session store is kept in memory for fast access. Session cookie expiration and database syncing timing are configurable. Note that this packages does not handle user authorization; you will have to roll your own (the package persistent is recommended) or use another package.
<a name="line-16"></a>
<a name="line-17"></a>Example usage:
<a name="line-18"></a>
<a name="line-19"></a>@
<a name="line-20"></a>\{\-\# LANGUAGE OverloadedStrings   \#\-\}
<a name="line-21"></a>\{\-\# LANGUAGE ScopedTypeVariables \#\-\}
<a name="line-22"></a>
<a name="line-23"></a>module Main where
<a name="line-24"></a>import qualified Data.Text.Lazy           as T
<a name="line-25"></a>import           Web.Scotty               as S
<a name="line-26"></a>import           Web.Scotty.Login.Session
<a name="line-27"></a>
<a name="line-28"></a>conf :: SessionConfig
<a name="line-29"></a>conf = defaultSessionConfig
<a name="line-30"></a>
<a name="line-31"></a>main :: IO ()
<a name="line-32"></a>main = do
<a name="line-33"></a>  initializeCookieDb conf
<a name="line-34"></a>  scotty 8000 routes
<a name="line-35"></a>
<a name="line-36"></a>routes :: ScottyM ()
<a name="line-37"></a>routes = do
<a name="line-38"></a>  S.get \"/denied\" $ S.text \"access denied\"
<a name="line-39"></a>  S.get \"/login\" $ do S.html $ T.pack $ unlines $
<a name="line-40"></a>                        [ \"\&lt;form method=\\\"POST\\\" action=\\\"/login\\\"\&gt;\"
<a name="line-41"></a>                        , \"\&lt;input type=\\\"text\\\" name=\\\"username\\\"\&gt;\"
<a name="line-42"></a>                        , \"\&lt;input type=\\\"password\\\" name=\\\"password\\\"\&gt;\"
<a name="line-43"></a>                        , \"\&lt;input type=\\\"submit\\\" name=\\\"login\\\" value=\\\"login\\\"\&gt;\"
<a name="line-44"></a>                        , \"\&lt;/form\&gt;\" ]
<a name="line-45"></a>  S.post \"/login\" $ do
<a name="line-46"></a>    (usn :: String) &lt;- param \"username\"
<a name="line-47"></a>    (pass :: String) &lt;- param \"password\"
<a name="line-48"></a>    if usn == \"guest\" &amp;&amp; pass == \"password\"
<a name="line-49"></a>      then do addSession conf
<a name="line-50"></a>              redirect \"/authed\"
<a name="line-51"></a>      else do redirect \"/denied\"
<a name="line-52"></a>  S.get \"\/authcheck\" $ authCheck (redirect \"\/denied\") $
<a name="line-53"></a>    S.text \"authorized\"
<a name="line-54"></a>@
<a name="line-55"></a>-}</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Web</span><span class='hs-varop'>.</span><span class='hs-conid'>Scotty</span><span class='hs-varop'>.</span><span class='hs-conid'>Login</span><span class='hs-varop'>.</span><span class='hs-conid'>Session</span> <span class='hs-layout'>(</span> <span class='hs-varid'>initializeCookieDb</span>
<a name="line-58"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>addSession</span>
<a name="line-59"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>authCheck</span>
<a name="line-60"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>authCheckWithSession</span>
<a name="line-61"></a>                                <span class='hs-layout'>,</span> <span class='hs-conid'>SessionConfig</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-62"></a>                                <span class='hs-layout'>,</span> <span class='hs-conid'>Session</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-63"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>defaultSessionConfig</span>
<a name="line-64"></a>                                <span class='hs-layout'>)</span>
<a name="line-65"></a>       <span class='hs-keyword'>where</span>
<a name="line-66"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span>                <span class='hs-layout'>(</span><span class='hs-varid'>forkIO</span><span class='hs-layout'>,</span> <span class='hs-varid'>threadDelay</span><span class='hs-layout'>)</span>
<a name="line-67"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-68"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>
<a name="line-69"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span>         <span class='hs-layout'>(</span><span class='hs-varid'>lift</span><span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-71"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Crypto</span><span class='hs-varop'>.</span><span class='hs-conid'>Random</span>                     <span class='hs-layout'>(</span><span class='hs-varid'>getRandomBytes</span><span class='hs-layout'>)</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span>                   <span class='hs-keyword'>as</span> <span class='hs-conid'>B</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span>                         <span class='hs-keyword'>as</span> <span class='hs-conid'>TS</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Lazy</span>                    <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
<a name="line-75"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Time</span><span class='hs-varop'>.</span><span class='hs-conid'>Clock</span>
<a name="line-76"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>Persist</span>                  <span class='hs-keyword'>as</span> <span class='hs-conid'>D</span>
<a name="line-77"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>Persist</span><span class='hs-varop'>.</span><span class='hs-conid'>Sqlite</span>
<a name="line-78"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>HTTP</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span><span class='hs-varop'>.</span><span class='hs-conid'>Status</span>         <span class='hs-layout'>(</span><span class='hs-varid'>forbidden403</span><span class='hs-layout'>)</span>
<a name="line-79"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Numeric</span>                           <span class='hs-layout'>(</span><span class='hs-varid'>showHex</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Web</span><span class='hs-varop'>.</span><span class='hs-conid'>Scotty</span><span class='hs-varop'>.</span><span class='hs-conid'>Cookie</span>                 <span class='hs-keyword'>as</span> <span class='hs-conid'>SC</span>
<a name="line-81"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Web</span><span class='hs-varop'>.</span><span class='hs-conid'>Scotty</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span>                  <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Web</span><span class='hs-varop'>.</span><span class='hs-conid'>Scotty</span><span class='hs-varop'>.</span><span class='hs-conid'>Login</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span><span class='hs-varop'>.</span><span class='hs-conid'>Cookies</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>C</span>
<a name="line-84"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Web</span><span class='hs-varop'>.</span><span class='hs-conid'>Scotty</span><span class='hs-varop'>.</span><span class='hs-conid'>Login</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span><span class='hs-varop'>.</span><span class='hs-conid'>Model</span>
<a name="line-85"></a>
<a name="line-86"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Logger</span>
<a name="line-87"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span><span class='hs-varop'>.</span><span class='hs-conid'>Control</span>
<a name="line-88"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span><span class='hs-varop'>.</span><span class='hs-conid'>Resource</span>      <span class='hs-layout'>(</span><span class='hs-conid'>ResourceT</span><span class='hs-layout'>,</span> <span class='hs-varid'>runResourceT</span><span class='hs-layout'>)</span>
<a name="line-89"></a>
<a name="line-90"></a>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>HashMap</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span>               <span class='hs-keyword'>as</span> <span class='hs-conid'>H</span>
<a name="line-92"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-93"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>                         <span class='hs-layout'>(</span><span class='hs-varid'>find</span><span class='hs-layout'>)</span>
<a name="line-94"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span>                  <span class='hs-layout'>(</span><span class='hs-varid'>unsafePerformIO</span><span class='hs-layout'>)</span>
<a name="line-95"></a>
<a name="line-96"></a><span class='hs-comment'>-- import qualified Data.Map                          as M</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="SessionConfig"></a><span class='hs-comment'>-- | Configuration for the session database.</span>
<a name="line-99"></a><a name="SessionConfig"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SessionConfig</span> <span class='hs-keyglyph'>=</span>
<a name="line-100"></a>  <span class='hs-conid'>SessionConfig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dbPath</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>          <span class='hs-comment'>-- ^ Path to SQLite database file</span>
<a name="line-101"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>syncInterval</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NominalDiffTime</span> <span class='hs-comment'>-- ^ Time between syncs to database (seconds)</span>
<a name="line-102"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>expirationInterval</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NominalDiffTime</span> <span class='hs-comment'>-- ^ Cookie expiration time (seconds)</span>
<a name="line-103"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>debugMode</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>            <span class='hs-comment'>-- ^ Debug Mode (extra logging)</span>
<a name="line-104"></a>                <span class='hs-layout'>}</span>
<a name="line-105"></a><span class='hs-comment'>{- data Session
<a name="line-106"></a>  = Session {sessionSid :: !T.Text, sessionExpiration :: !UTCTime} -}</span>
<a name="line-107"></a>
<a name="line-108"></a><a name="SessionVault"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SessionVault</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>H</span><span class='hs-varop'>.</span><span class='hs-conid'>HashMap</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-conid'>Session</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="SessionStore"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>SessionStore</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>SessionVault</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-comment'>-- | Default settings for the session store. May not be suitable for all applications.</span>
<a name="line-113"></a><span class='hs-comment'>--</span>
<a name="line-114"></a><span class='hs-comment'>-- They are:</span>
<a name="line-115"></a><span class='hs-comment'>--</span>
<a name="line-116"></a><span class='hs-comment'>-- * dbPath = \"sessions.sqlite\",</span>
<a name="line-117"></a><span class='hs-comment'>--</span>
<a name="line-118"></a><span class='hs-comment'>-- * syncInterval = 1200 seconds (30 minutes),</span>
<a name="line-119"></a><span class='hs-comment'>--</span>
<a name="line-120"></a><span class='hs-comment'>-- * expirationInterval = 86400 seconds (1 day)</span>
<a name="line-121"></a><span class='hs-comment'>--</span>
<a name="line-122"></a><span class='hs-comment'>-- * debugMode = False</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="defaultSessionConfig"></a><span class='hs-definition'>defaultSessionConfig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SessionConfig</span>
<a name="line-125"></a><span class='hs-definition'>defaultSessionConfig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SessionConfig</span> <span class='hs-str'>"sessions.sqlite3"</span> <span class='hs-num'>1200</span> <span class='hs-num'>120</span> <span class='hs-conid'>False</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="vault"></a><span class='hs-comment'>{-# NOINLINE vault #-}</span>
<a name="line-128"></a><span class='hs-definition'>vault</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SessionStore</span>
<a name="line-129"></a><span class='hs-definition'>vault</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>H</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="readVault"></a><span class='hs-definition'>readVault</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>SessionVault</span>
<a name="line-132"></a><span class='hs-definition'>readVault</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>vault</span>
<a name="line-133"></a>
<a name="line-134"></a><a name="modifyVault"></a><span class='hs-definition'>modifyVault</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>SessionVault</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SessionVault</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-135"></a><span class='hs-definition'>modifyVault</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>atomicModifyIORef'</span> <span class='hs-varid'>vault</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-conid'>(,)</span> <span class='hs-conid'>()</span> <span class='hs-varop'>.</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="initializeCookieDb"></a><span class='hs-comment'>-- | Reload the session database into memory, and fork the database sync and cleanup thread. This must be called before invoking scotty.</span>
<a name="line-138"></a><span class='hs-definition'>initializeCookieDb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SessionConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-139"></a><span class='hs-definition'>initializeCookieDb</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span>  <span class='hs-keyword'>do</span>
<a name="line-140"></a>  <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-141"></a>  <span class='hs-varid'>ses</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runDB</span> <span class='hs-varid'>c</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>runMigration</span> <span class='hs-varid'>migrateAll</span>
<a name="line-142"></a>                      <span class='hs-varid'>selectList</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SessionExpiration</span> <span class='hs-varop'>&gt;=.</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>[]</span>
<a name="line-143"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>sessions</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>entityVal</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>ses</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Session</span><span class='hs-keyglyph'>]</span>
<a name="line-144"></a>      <span class='hs-varid'>seshMap</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>H</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>sessionSid</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>sessions</span>
<a name="line-145"></a>  <span class='hs-varid'>modifyVault</span> <span class='hs-varop'>$</span> <span class='hs-varid'>const</span> <span class='hs-varid'>seshMap</span>
<a name="line-146"></a>  <span class='hs-varid'>forkIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dbSyncAndCleanupLoop</span> <span class='hs-varid'>c</span>
<a name="line-147"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-148"></a>
<a name="line-149"></a><a name="dbSyncAndCleanupLoop"></a><span class='hs-definition'>dbSyncAndCleanupLoop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SessionConfig</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-150"></a><span class='hs-definition'>dbSyncAndCleanupLoop</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-151"></a>  <span class='hs-varid'>threadDelay</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>floor</span> <span class='hs-varop'>$</span> <span class='hs-varid'>syncInterval</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-num'>1000000</span>
<a name="line-152"></a>  <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-153"></a>  <span class='hs-varid'>vaultContents</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readVault</span>
<a name="line-154"></a>  <span class='hs-varid'>runDB</span> <span class='hs-varid'>c</span> <span class='hs-varop'>$</span> <span class='hs-varid'>deleteWhere</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SessionExpiration</span> <span class='hs-varop'>&gt;=.</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- delete all sessions in db</span>
<a name="line-155"></a>  <span class='hs-varid'>runDB</span> <span class='hs-varid'>c</span> <span class='hs-varop'>$</span> <span class='hs-varid'>deleteWhere</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SessionExpiration</span> <span class='hs-varop'>&lt;=.</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>]</span>
<a name="line-156"></a>  <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>runDB</span> <span class='hs-varid'>c</span> <span class='hs-varop'>.</span> <span class='hs-varid'>insert</span><span class='hs-layout'>)</span> <span class='hs-varid'>vaultContents</span> <span class='hs-comment'>-- add vault to db</span>
<a name="line-157"></a>  <span class='hs-varid'>modifyVault</span> <span class='hs-varop'>$</span> <span class='hs-conid'>H</span><span class='hs-varop'>.</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sessionExpiration</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-158"></a>  <span class='hs-varid'>dbSyncAndCleanupLoop</span> <span class='hs-varid'>c</span> <span class='hs-comment'>-- tail (hopefully) recurse</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="addSession"></a><span class='hs-comment'>-- | Add a session. This gives the user a SessionId cookie, and inserts a corresponding entry into the session store. It also returns the Session that was just inserted.</span>
<a name="line-161"></a><span class='hs-definition'>addSession</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SessionConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ActionT</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Session</span><span class='hs-layout'>)</span>
<a name="line-162"></a><span class='hs-definition'>addSession</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-163"></a>  <span class='hs-varid'>vc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>readVault</span>
<a name="line-164"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>debugMode</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>print</span> <span class='hs-varop'>$</span> <span class='hs-str'>"adding session"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>vc</span>
<a name="line-165"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>bh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getRandomBytes</span> <span class='hs-num'>128</span>
<a name="line-166"></a>  <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-167"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TS</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mconcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varop'>`showHex`</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>unpack</span> <span class='hs-varid'>bh</span>
<a name="line-168"></a>      <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addUTCTime</span> <span class='hs-layout'>(</span><span class='hs-varid'>expirationInterval</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span>
<a name="line-169"></a>  <span class='hs-conid'>C</span><span class='hs-varop'>.</span><span class='hs-varid'>setSimpleCookieExpr</span> <span class='hs-str'>"SessionId"</span> <span class='hs-varid'>val</span> <span class='hs-varid'>t'</span>
<a name="line-170"></a>  <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>insertSession</span> <span class='hs-layout'>(</span><span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>fromStrict</span> <span class='hs-varid'>val</span><span class='hs-layout'>)</span> <span class='hs-varid'>t'</span>
<a name="line-171"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Session</span> <span class='hs-layout'>(</span><span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>fromStrict</span> <span class='hs-varid'>val</span><span class='hs-layout'>)</span> <span class='hs-varid'>t'</span>
<a name="line-172"></a>
<a name="line-173"></a>
<a name="line-174"></a><a name="authCheck"></a><span class='hs-comment'>-- | Check whether a user is authorized.</span>
<a name="line-175"></a><span class='hs-comment'>--</span>
<a name="line-176"></a><span class='hs-comment'>-- Example usage:</span>
<a name="line-177"></a><span class='hs-comment'>--</span>
<a name="line-178"></a><span class='hs-comment'>-- @</span>
<a name="line-179"></a><span class='hs-comment'>--    S.get \"\/auth_test\" $ authCheck (redirect \"\/denied\") $</span>
<a name="line-180"></a><span class='hs-comment'>--      S.text "authorized"</span>
<a name="line-181"></a><span class='hs-comment'>-- @</span>
<a name="line-182"></a><span class='hs-definition'>authCheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ScottyError</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-183"></a>             <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ActionT</span> <span class='hs-varid'>e</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- ^ The action to perform if user is denied</span>
<a name="line-184"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ActionT</span> <span class='hs-varid'>e</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- ^ The action to perform if user is authorized</span>
<a name="line-185"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ActionT</span> <span class='hs-varid'>e</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-186"></a><span class='hs-definition'>authCheck</span> <span class='hs-varid'>d</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-187"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>forbiddenAction</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>status</span> <span class='hs-varid'>forbidden403</span>
<a name="line-188"></a>  <span class='hs-varid'>vaultContents</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>readVault</span>
<a name="line-189"></a>  <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runMaybeT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-190"></a>    <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lift</span> <span class='hs-layout'>(</span><span class='hs-conid'>SC</span><span class='hs-varop'>.</span><span class='hs-varid'>getCookie</span> <span class='hs-str'>"SessionId"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>liftMaybe</span>
<a name="line-191"></a>    <span class='hs-varid'>session</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftMaybe</span> <span class='hs-varop'>$</span> <span class='hs-conid'>H</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>fromStrict</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>vaultContents</span>
<a name="line-192"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sessionExpiration</span> <span class='hs-varid'>session</span>
<a name="line-193"></a>    <span class='hs-varid'>curTime</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-194"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>diffUTCTime</span> <span class='hs-varid'>t</span> <span class='hs-varid'>curTime</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>a</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>mzero</span>
<a name="line-195"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-196"></a>    <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-197"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>forbiddenAction</span>
<a name="line-198"></a>
<a name="line-199"></a>
<a name="line-200"></a><a name="authCheckWithSession"></a><span class='hs-comment'>-- | Check whether a user is authorized, and return the Session that they are authorized for</span>
<a name="line-201"></a><span class='hs-comment'>--</span>
<a name="line-202"></a><span class='hs-comment'>-- Example usage:</span>
<a name="line-203"></a><span class='hs-comment'>--</span>
<a name="line-204"></a><span class='hs-comment'>-- @</span>
<a name="line-205"></a><span class='hs-comment'>--    S.get \"\/auth_test\" $ authCheck (redirect \"\/denied\") $</span>
<a name="line-206"></a><span class='hs-comment'>--      \s -&gt; S.text $ "authorized as " ++ show s</span>
<a name="line-207"></a><span class='hs-comment'>-- @</span>
<a name="line-208"></a><span class='hs-definition'>authCheckWithSession</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>ScottyError</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-209"></a>                        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ActionT</span> <span class='hs-varid'>e</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- ^ The action to perform if user is denied</span>
<a name="line-210"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Session</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ActionT</span> <span class='hs-varid'>e</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ The action to perform if user is authorized</span>
<a name="line-211"></a>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ActionT</span> <span class='hs-varid'>e</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-212"></a><span class='hs-definition'>authCheckWithSession</span> <span class='hs-varid'>d</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-213"></a>  <span class='hs-varid'>vaultContents</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>readVault</span>
<a name="line-214"></a>  <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>SC</span><span class='hs-varop'>.</span><span class='hs-varid'>getCookie</span> <span class='hs-str'>"SessionId"</span>
<a name="line-215"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>of</span>
<a name="line-216"></a>   <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>d</span>
<a name="line-217"></a>   <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- Text</span>
<a name="line-218"></a>     <span class='hs-comment'>-- liftIO $ runDB conf $ selectFirst [SessionSid ==. T.fromStrict v] []</span>
<a name="line-219"></a>     <span class='hs-keyword'>let</span> <span class='hs-varid'>session</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sessionSid</span> <span class='hs-varid'>s</span> <span class='hs-varop'>==</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>fromStrict</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>vaultContents</span>
<a name="line-220"></a>     <span class='hs-keyword'>case</span> <span class='hs-varid'>session</span> <span class='hs-keyword'>of</span>
<a name="line-221"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>d</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>status</span> <span class='hs-varid'>forbidden403</span>
<a name="line-222"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- s = entityVal e</span>
<a name="line-223"></a>                     <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sessionExpiration</span> <span class='hs-varid'>s</span>
<a name="line-224"></a>                   <span class='hs-varid'>curTime</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-225"></a>                   <span class='hs-keyword'>if</span> <span class='hs-varid'>diffUTCTime</span> <span class='hs-varid'>t</span> <span class='hs-varid'>curTime</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span>
<a name="line-226"></a>                     <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>a</span>
<a name="line-227"></a>                          <span class='hs-comment'>-- this shouldnt happen, browser should delete it</span>
<a name="line-228"></a>                     <span class='hs-keyword'>else</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>status</span> <span class='hs-varid'>forbidden403</span>
<a name="line-229"></a>
<a name="line-230"></a>
<a name="line-231"></a><a name="insertSession"></a><span class='hs-comment'>-- now have to sync in-mem db to sqlite db</span>
<a name="line-232"></a><span class='hs-definition'>insertSession</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span>
<a name="line-233"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UTCTime</span>
<a name="line-234"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-235"></a><span class='hs-definition'>insertSession</span> <span class='hs-varid'>sid</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyVault</span> <span class='hs-varop'>$</span> <span class='hs-conid'>H</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>sid</span> <span class='hs-layout'>(</span><span class='hs-conid'>Session</span> <span class='hs-varid'>sid</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-236"></a>
<a name="line-237"></a>
<a name="line-238"></a>
<a name="line-239"></a><a name="runDB"></a><span class='hs-definition'>runDB</span>
<a name="line-240"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBaseControl</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-241"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SessionConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SqlPersistT</span> <span class='hs-layout'>(</span><span class='hs-conid'>LoggingT</span> <span class='hs-layout'>(</span><span class='hs-conid'>ResourceT</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-242"></a><span class='hs-definition'>runDB</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runSqlite'</span> <span class='hs-varid'>c</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TS</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dbPath</span> <span class='hs-varid'>c</span>
<a name="line-243"></a>
<a name="line-244"></a><a name="runSqlite'"></a><span class='hs-definition'>runSqlite'</span>
<a name="line-245"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBaseControl</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-246"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SessionConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TS</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SqlPersistT</span> <span class='hs-layout'>(</span><span class='hs-conid'>LoggingT</span> <span class='hs-layout'>(</span><span class='hs-conid'>ResourceT</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-247"></a><span class='hs-definition'>runSqlite'</span> <span class='hs-varid'>conf</span> <span class='hs-varid'>connstr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runResourceT</span>
<a name="line-248"></a>                               <span class='hs-varop'>.</span> <span class='hs-varid'>runStderrLoggingT</span>
<a name="line-249"></a>                               <span class='hs-varop'>.</span> <span class='hs-varid'>filterLogger</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>debugMode</span> <span class='hs-varid'>conf</span><span class='hs-layout'>)</span>
<a name="line-250"></a>                               <span class='hs-varop'>.</span> <span class='hs-varid'>withSqliteConn</span> <span class='hs-varid'>connstr</span>
<a name="line-251"></a>                               <span class='hs-varop'>.</span> <span class='hs-varid'>runSqlConn</span>
<a name="line-252"></a>
<a name="line-253"></a>
<a name="line-254"></a><a name="liftMaybe"></a><span class='hs-comment'>-- helper function for MaybeT</span>
<a name="line-255"></a><span class='hs-definition'>liftMaybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-256"></a><span class='hs-definition'>liftMaybe</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>.</span> <span class='hs-varid'>return</span>
</pre></body>
</html>
